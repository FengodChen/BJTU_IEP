<style>
    .operator {
        font-family: sans-serif;
        color: aliceblue;
        position: absolute;
        top: 50px;
        bottom: 0;
        width: 220px;
        background-color: #222;
    }
    .drawer{
        position: absolute;
        top: 50px;
        bottom: 0;
        left: 220px;
        right: 0;
        background-color: #444;
    }

    .drawer div {
        position: absolute;
        left: 10px;
        right: 10px;
        top: 10px;
        bottom: 10px;
        background-color: #555;
    }

    .drawer_pannel canvas {
        position: absolute;
        height: 100%;
        width: 100%;
        border:1px solid #c3c3c3;
    }
</style>

<div class="operator">
    <p>路段名字</p>
    <input type="text" list="roadans" id="roadkeys">
        <datalist id="roadans"></datalist>
    </input>
    <button id="refresh"> 载入此路段 </button>
    <p>操作台</p>
    <input type="text" list="road_selection" id="road_function" >
        <datalist id="road_selection">
            <option value="左转车道">  </option>
            <option value="右转车道">  </option>
            <option value="直行车道">  </option>
        </datalist>
    </input>
    <button id="add_lane"> 确认车道 </button>
    <button id="save"> 确认并保存 </button>
</div>
<div class="drawer">
    <div class="drawer_pannel">
        <canvas id="drawCanvas"></canvas>
    </div>
</div>

<script>
    var Point = function(x_, y_) { return {x:x_, y:y_} }
    var pointList = new Array()
    var roadImg = new Image();

    $(function() {
        $(window).resize(resizeCanvas);
        resizeCanvas();
    });
 
    function resizeCanvas() {
        $("#drawCanvas").attr("width", $('#drawCanvas').width());
        $("#drawCanvas").attr("height", $('#drawCanvas').height());
    };

    $(document).ready(function(){
        var canvas = $("#drawCanvas");
        var context = canvas[0].getContext('2d');
        var abs_y = canvas.offset().top;
        var abs_x = canvas.offset().left;

        var mouseFlag = false;

        roadImg.onload = function() {
            var c_h = canvas.height();
            var c_w = canvas.width();
            context.drawImage(roadImg, 0, 0, c_w, c_h);
        }

        //canvas.click(function(e){
        $("#drawCanvas").click(function(e){
            rel_x = e.clientX - abs_x;
            rel_y = e.clientY - abs_y;
            if (!mouseFlag) {
                mouseFlag = true;
                tmp_x = rel_x;
                tmp_y = rel_y;
                pointList.push(Point(rel_x, rel_y))
            } else {
                context.beginPath();
                context.moveTo(tmp_x, tmp_y);
                context.lineTo(rel_x, rel_y);
                tmp_x = rel_x;
                tmp_y = rel_y;
                context.strokeStyle="red";
                context.stroke();
                pointList.push(Point(rel_x, rel_y))
            }
        });

        $("#add_lane").click(function() {
            if (pointList.length <=2) {
                alert("Point number must larger than 2!");
            } else {
                pointList_json = JSON.stringify(pointList);
                lane = $("#road_function").val()
                $.post("/post/manualDraw",
                {pointList_json:pointList_json, lane:lane}, function(recv){
                    roadImg.src = recv;
                });
                mouseFlag = false
                pointList = new Array();
            }
        });

        $("#refresh").click(function() {
            var c_h = canvas.height();
            var c_w = canvas.width();
            road = $("#roadkeys").val();
            $.post("/post/refreshImg",
            {w:c_w, h:c_h, road:road}, function(recv){
                roadImg.src = recv;
                mouseFlag = false
                pointList = new Array();
            });
        });

        $("#save").click(function() {
            $.post("/post/saveDraw",
            {m:0}, function(recv){
                mouseFlag = false
                pointList = new Array();
            });
        });

        $("#roadkeys").keyup(function(){
            roadkeys = $("#roadkeys").val();
            $.post("/post/getMonitorList", 
            {roadkey:roadkeys}, function(recv){
                $("#roadans").html(recv);
            });
        });

    });
</script>